<%= form_for @reply do |r| %>

  <%= r.hidden_field :ticket_id %>
  <h5 class="mt">Reply</h5>
  <dl class="tabs" data-tab>
    <dd class="active"><a href="#edit">Edit</a></dd>
    <dd><a href="#preview">Preview</a></dd>
  </dl>
  <div class="tabs-content panel">
    <div class="content active full" id="edit">
      <div class="row">
        <div class="large-4 columns">
          <%= r.label :to, 'To' %>
          <%= r.text_field :to %>
        </div>
        <div class="large-4 columns">
          <%= r.label :cc, 'Cc' %>
          <%= r.text_field :cc %>
        </div>
        <div class="large-4 columns">
          <%= r.label :bcc, 'Bcc' %>
          <%= r.text_field :bcc %>
        </div>
      </div>

      <%= r.text_area :content %>
      <p>Replies are parsed with <a target="_blank" href="http://daringfireball.net/projects/markdown/syntax">Markdown</a>.</p>

      <% markdown = Redcarpet::Markdown.new Redcarpet::Render::HTML %>
      <%= markdown.render(current_user.signature.to_s).html_safe %>

      <%= r.fields_for :attachments, Attachment.new, child_index: nil do |a| %>
        <%= a.label :file, 'Attach file(s)' %>
        <%= a.file_field :file, multiple: true %>
      <% end %>
    </div>
    <div class="content full" id="preview">
      <%= markdown.render(@reply.content.to_s).html_safe %>
      <%= markdown.render(current_user.signature.to_s).html_safe %>
    </div>
  </div>
  <p>
    <%= r.submit value: 'Send reply', class: 'button regular radius' %>
  </p>
<% end %>

<script>
  jQuery(document).ready(function() { 
    jQuery('#reply_to, #reply_cc, #reply_bcc').select2({        
        width: 'resolve',
        createSearchChoice:function(term, data) {
            if (jQuery(data).filter(function() {
                return this.text.localeCompare(term)===0; }).length===0) {
                    return {id:term, text:term};
                }
            },
        multiple: true,
        ajax: {
          url: "/users",
          dataType: 'json',
          data: function (term, page) {
            return {
              q: term
            };
          },
          results: function (data) {
            console.log(data);
            return { results: data.users };
          }
        }        
    });
  });
</script>
